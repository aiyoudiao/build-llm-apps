<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å±</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { 
            font-family: 'Microsoft YaHei', 'Hiragino Sans GB', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .chart {
            height: 400px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ğŸ‡­ğŸ‡° é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å±</h1>
            <p>å®æ—¶ç–«æƒ…æ•°æ®åˆ†æä¸ç›‘æ§ç³»ç»Ÿ</p>
        </div>

        <!-- æ•°æ®æ¦‚è§ˆ -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">æ€»å¤©æ•°</div>
                <div class="stat-value" id="totalDays">365</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ€»ç¡®è¯Šæ•°</div>
                <div class="stat-value" id="totalCases">450,583</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€é«˜å•æ—¥æ–°å¢</div>
                <div class="stat-value" id="maxDailyCases">15,847</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">åŒºåŸŸæ•°é‡</div>
                <div class="stat-value" id="regionsCount">18</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-grid">
            <!-- å›¾è¡¨1: æ¯æ—¥æ–°å¢è¶‹åŠ¿ -->
            <div class="chart-container">
                <div class="chart-title">æ¯æ—¥æ–°å¢ç¡®è¯Šè¶‹åŠ¿</div>
                <div class="chart" id="dailyTrendChart"></div>
            </div>

            <!-- å›¾è¡¨2: åŒºåŸŸåˆ†å¸ƒé¥¼å›¾ -->
            <div class="chart-container">
                <div class="chart-title">å„åŒºåŸŸç¡®è¯Šåˆ†å¸ƒ</div>
                <div class="chart" id="regionPieChart"></div>
            </div>

            <!-- å›¾è¡¨3: å‰5åŒºåŸŸè¶‹åŠ¿ -->
            <div class="chart-container">
                <div class="chart-title">å‰5åŒºåŸŸè¶‹åŠ¿å¯¹æ¯”</div>
                <div class="chart" id="topRegionsChart"></div>
            </div>

            <!-- å›¾è¡¨4: é£é™©ç­‰çº§åˆ†å¸ƒ -->
            <div class="chart-container">
                <div class="chart-title">é£é™©ç­‰çº§åˆ†å¸ƒ</div>
                <div class="chart" id="riskChart"></div>
            </div>
        </div>

        <div class="footer">
            <p>é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å± | æ•°æ®æ›´æ–°æ—¶é—´: 2022å¹´12æœˆ31æ—¥</p>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å›¾è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            const dailyTrendChart = echarts.init(document.getElementById('dailyTrendChart'));
            const regionPieChart = echarts.init(document.getElementById('regionPieChart'));
            const topRegionsChart = echarts.init(document.getElementById('topRegionsChart'));
            const riskChart = echarts.init(document.getElementById('riskChart'));

            // è·å–æ•°æ®æ¦‚è§ˆ
            fetch('/api/summary')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalDays').textContent = data.total_days;
                    document.getElementById('totalCases').textContent = data.total_cases.toLocaleString();
                    document.getElementById('maxDailyCases').textContent = data.max_daily_cases.toLocaleString();
                    document.getElementById('regionsCount').textContent = data.regions_count;
                    
                    // æ›´æ–°é¡µè„šæ—¶é—´
                    const footer = document.querySelector('.footer p');
                    footer.textContent = `é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å± | æ•°æ®èŒƒå›´: ${data.data_range.start} è‡³ ${data.data_range.end}`;
                })
                .catch(error => {
                    console.error('è·å–æ•°æ®æ¦‚è§ˆå¤±è´¥:', error);
                });

            // è·å–æ¯æ—¥è¶‹åŠ¿æ•°æ®
            fetch('/api/daily_trend')
                .then(response => response.json())
                .then(data => {
                    const dates = data.map(item => item.date);
                    const cases = data.map(item => item.cases);
                    
                    dailyTrendChart.setOption({
                        tooltip: {
                            trigger: 'axis',
                            formatter: '{b}<br/>æ–°å¢ç¡®è¯Š: {c} ä¾‹'
                        },
                        xAxis: {
                            type: 'category',
                            data: dates,
                            axisLabel: {
                                rotate: 45,
                                fontSize: 10
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'æ–°å¢ç¡®è¯Šäººæ•°',
                            splitLine: {
                                lineStyle: {
                                    type: 'dashed'
                                }
                            }
                        },
                        series: [{
                            data: cases,
                            type: 'line',
                            smooth: true,
                            areaStyle: {},
                            itemStyle: {
                                color: '#2E86AB'
                            },
                            lineStyle: {
                                width: 2
                            }
                        }]
                    });
                })
                .catch(error => {
                    console.error('è·å–æ¯æ—¥è¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
                });

            // è·å–åŒºåŸŸç»Ÿè®¡æ•°æ®
            fetch('/api/region_stats')
                .then(response => response.json())
                .then(data => {
                    const pieData = data.map(item => ({
                        value: item.cases,
                        name: item.region
                    }));
                    
                    regionPieChart.setOption({
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}: {c} ä¾‹ ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'left'
                        },
                        series: [{
                            name: 'ç¡®è¯Šåˆ†å¸ƒ',
                            type: 'pie',
                            radius: '50%',
                            center: ['50%', '60%'],
                            data: pieData,
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }]
                    });
                })
                .catch(error => {
                    console.error('è·å–åŒºåŸŸç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                });

            // è·å–å‰5åŒºåŸŸè¶‹åŠ¿æ•°æ®
            fetch('/api/top_regions_trend')
                .then(response => response.json())
                .then(data => {
                    const series = [];
                    const legendData = [];
                    
                    Object.keys(data).forEach(region => {
                        legendData.push(region);
                        series.push({
                            name: region,
                            type: 'line',
                            data: data[region].map(item => item.cases),
                            smooth: true
                        });
                    });
                    
                    // æå–æ—¥æœŸä½œä¸ºxè½´
                    const dates = data[Object.keys(data)[0]].map(item => item.date);
                    
                    topRegionsChart.setOption({
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(params) {
                                let result = params[0].name + '<br/>';
                                params.forEach(param => {
                                    result += param.seriesName + ': ' + param.value + ' ä¾‹<br/>';
                                });
                                return result;
                            }
                        },
                        legend: {
                            data: legendData,
                            top: '5%'
                        },
                        xAxis: {
                            type: 'category',
                            data: dates
                        },
                        yAxis: {
                            type: 'value',
                            name: 'ç¡®è¯Šäººæ•°'
                        },
                        series: series
                    });
                })
                .catch(error => {
                    console.error('è·å–å‰5åŒºåŸŸè¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
                });

            // è·å–é£é™©ç­‰çº§åˆ†å¸ƒæ•°æ®
            fetch('/api/risk_distribution')
                .then(response => response.json())
                .then(data => {
                    const riskData = [
                        { value: data['é«˜é£é™©'] || 0, name: 'é«˜é£é™©', itemStyle: { color: '#e74c3c' } },
                        { value: data['ä¸­é£é™©'] || 0, name: 'ä¸­é£é™©', itemStyle: { color: '#f39c12' } },
                        { value: data['ä½é£é™©'] || 0, name: 'ä½é£é™©', itemStyle: { color: '#27ae60' } }
                    ];
                    
                    riskChart.setOption({
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}: {c} ä¸ªåŒºåŸŸ ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'left'
                        },
                        series: [{
                            name: 'é£é™©ç­‰çº§',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            center: ['50%', '60%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '18',
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: riskData
                        }]
                    });
                })
                .catch(error => {
                    console.error('è·å–é£é™©ç­‰çº§åˆ†å¸ƒæ•°æ®å¤±è´¥:', error);
                });

            // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç½®å›¾è¡¨å¤§å°
            window.addEventListener('resize', function() {
                dailyTrendChart.resize();
                regionPieChart.resize();
                topRegionsChart.resize();
                riskChart.resize();
            });
        });
    </script>
</body>
</html>