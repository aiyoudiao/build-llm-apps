<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å±</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- å¼•å…¥ Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-container {
            max-width: 1920px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
            text-align: center;
        }
        
        .header .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-top: 10px;
            font-size: 1.1rem;
        }
        
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-card.primary .metric-value {
            color: #3498db;
        }
        
        .metric-card.success .metric-value {
            color: #2ecc71;
        }
        
        .metric-card.warning .metric-value {
            color: #f39c12;
        }
        
        .metric-card.danger .metric-value {
            color: #e74c3c;
        }
        
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #3498db;
        }
        
        .chart-container {
            height: 400px;
            width: 100%;
        }
        
        .chart-container.large {
            height: 500px;
        }
        
        @media (max-width: 768px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
            
            .metrics-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <div class="header">
            <h1>ğŸ¥ é¦™æ¸¯ç–«æƒ…æ•°æ®å¯è§†åŒ–å¤§å±</h1>
            <div class="subtitle" id="data-date">æ•°æ®åŠ è½½ä¸­...</div>
        </div>
        
        <!-- æŒ‡æ ‡å¡ç‰‡åŒºåŸŸ -->
        <div class="metrics-row">
            <div class="metric-card primary">
                <div class="metric-value" id="total-cumulative">0</div>
                <div class="metric-label">ç´¯è®¡ç¡®è¯Š</div>
            </div>
            <div class="metric-card warning">
                <div class="metric-value" id="total-active">0</div>
                <div class="metric-label">ç°å­˜ç¡®è¯Š</div>
            </div>
            <div class="metric-card success">
                <div class="metric-value" id="total-recovered">0</div>
                <div class="metric-label">ç´¯è®¡åº·å¤</div>
            </div>
            <div class="metric-card danger">
                <div class="metric-value" id="total-deaths">0</div>
                <div class="metric-label">ç´¯è®¡æ­»äº¡</div>
            </div>
        </div>
        
        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-row">
            <!-- å›¾è¡¨1: å…¨æ¸¯æ¯æ—¥æ–°å¢ç¡®è¯Šè¶‹åŠ¿ -->
            <div class="chart-card" style="grid-column: span 2;">
                <div class="chart-title">ğŸ“ˆ å…¨æ¸¯æ¯æ—¥æ–°å¢ç¡®è¯Šè¶‹åŠ¿</div>
                <div id="trendChart" class="chart-container large"></div>
            </div>
        </div>

        <div class="charts-row">
            <!-- å›¾è¡¨2: é¦™æ¸¯å„åŒºç–«æƒ…çƒ­åŠ›åœ°å›¾ï¼ˆå¯åˆ‡æ¢ä¸åŒæŒ‡æ ‡ï¼‰ -->
            <div class="chart-card" style="grid-column: span 2;">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="chart-title mb-0">ğŸ—ºï¸ é¦™æ¸¯å„åŒºç–«æƒ…çƒ­åŠ›åˆ†å¸ƒ</div>
                    <div class="d-flex align-items-center gap-2">
                        <span style="font-size: 0.9rem; color: #7f8c8d;">ç€è‰²æŒ‡æ ‡ï¼š</span>
                        <select id="mapMetricSelect" class="form-select form-select-sm" style="width: 180px;">
                            <!-- ä¸é¡¶éƒ¨æŒ‡æ ‡å¡ä¿æŒè¯­ä¹‰ä¸€è‡´ï¼Œé»˜è®¤ä½¿ç”¨â€œç´¯è®¡ç¡®è¯Šâ€ -->
                            <option value="cumulative" selected>ç´¯è®¡ç¡®è¯Š</option>
                            <option value="active">ç°å­˜ç¡®è¯Š</option>
                            <option value="recovered">ç´¯è®¡åº·å¤</option>
                            <option value="deaths">ç´¯è®¡æ­»äº¡</option>
                        </select>
                    </div>
                </div>
                <div id="hkMapChart" class="chart-container large"></div>
            </div>
        </div>
        
        <div class="charts-row">
            <!-- å›¾è¡¨3: å„åŒºç´¯è®¡ç¡®è¯Šæ’è¡Œ -->
            <div class="chart-card">
                <div class="chart-title">ğŸ“Š å„åŒºç´¯è®¡ç¡®è¯Šæ’è¡Œ</div>
                <div id="districtBarChart" class="chart-container"></div>
            </div>
            
            <!-- å›¾è¡¨4: é£é™©ç­‰çº§åˆ†å¸ƒ -->
            <div class="chart-card">
                <div class="chart-title">ğŸ¯ å„åŒºé£é™©ç­‰çº§åˆ†å¸ƒ</div>
                <div id="riskChart" class="chart-container"></div>
            </div>
        </div>
        
        <div class="charts-row">
            <!-- å›¾è¡¨5: é‡ç‚¹åœ°åŒºæ–°å¢ç¡®è¯Šè¶‹åŠ¿å¯¹æ¯” -->
            <div class="chart-card" style="grid-column: span 2;">
                <div class="chart-title">ğŸ“‰ é‡ç‚¹åœ°åŒºï¼ˆTop 5ï¼‰æ–°å¢ç¡®è¯Šè¶‹åŠ¿å¯¹æ¯”</div>
                <div id="top5TrendChart" class="chart-container large"></div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
        const trendChart = echarts.init(document.getElementById('trendChart'));
        const hkMapChart = echarts.init(document.getElementById('hkMapChart'));
        const districtBarChart = echarts.init(document.getElementById('districtBarChart'));
        const riskChart = echarts.init(document.getElementById('riskChart'));
        const top5TrendChart = echarts.init(document.getElementById('top5TrendChart'));

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜å›¾è¡¨
        window.addEventListener('resize', function() {
            trendChart.resize();
            hkMapChart.resize();
            districtBarChart.resize();
            riskChart.resize();
            top5TrendChart.resize();
        });

        // 1. åŠ è½½æ¦‚è§ˆæ•°æ®
        fetch('/api/summary')
            .then(response => response.json())
            .then(data => {
                document.getElementById('data-date').textContent = 'æ•°æ®æ›´æ–°æ—¥æœŸï¼š' + data.date;
                document.getElementById('total-cumulative').textContent = data.cumulative.toLocaleString();
                document.getElementById('total-active').textContent = data.active.toLocaleString();
                document.getElementById('total-recovered').textContent = data.recovered.toLocaleString();
                document.getElementById('total-deaths').textContent = data.deaths.toLocaleString();
            })
            .catch(error => console.error('åŠ è½½æ¦‚è§ˆæ•°æ®å¤±è´¥:', error));

        // 2. åŠ è½½å…¨æ¸¯è¶‹åŠ¿å›¾
        fetch('/api/trend')
            .then(response => response.json())
            .then(data => {
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: data.dates,
                        axisLabel: {
                            rotate: 45,
                            interval: Math.floor(data.dates.length / 10)
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'æ–°å¢ç¡®è¯Šäººæ•°'
                    },
                    series: [{
                        name: 'æ–°å¢ç¡®è¯Š',
                        type: 'line',
                        smooth: true,
                        data: data.new_cases,
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(231, 76, 60, 0.8)'
                                }, {
                                    offset: 1, color: 'rgba(231, 76, 60, 0.1)'
                                }]
                            }
                        },
                        itemStyle: {
                            color: '#e74c3c'
                        },
                        lineStyle: {
                            width: 3
                        }
                    }]
                };
                trendChart.setOption(option);
            })
            .catch(error => console.error('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥:', error));

        // 3. åŠ è½½é¦™æ¸¯å„åŒºåœ°å›¾ï¼ˆæ”¯æŒåˆ‡æ¢ä¸åŒæŒ‡æ ‡çš„çƒ­åŠ›ï¼‰
        // ä½¿ç”¨é¦™æ¸¯æ”¿åºœæä¾›çš„ 18 åŒºè¾¹ç•Œ GeoJSONï¼Œç„¶åå†åŠ è½½åç«¯çš„ç–«æƒ…æ•°æ®
        Promise.all([
            fetch('https://www.had.gov.hk/psi/hong-kong-administrative-boundaries/hksar_18_district_boundary.json').then(r => r.json()),
            fetch('/api/map/districts').then(r => r.json())
        ])
        .then(([geoJson, mapData]) => {
            // ä¸ºæ¯ä¸ª feature å†™å…¥ç»Ÿä¸€çš„ name å­—æ®µï¼ˆä½¿ç”¨ã€Œåœ°å€ã€å±æ€§ï¼Œç¡®ä¿ä¸åç«¯è¿”å›çš„ name å¯¹é½ï¼‰
            if (geoJson && Array.isArray(geoJson.features)) {
                geoJson.features.forEach(f => {
                    const props = f.properties || {};
                    const districtName = props['åœ°å€'] || props['District'] || props.name;
                    if (districtName) {
                        props.name = districtName;
                    }
                });
            }

            // æ³¨å†Œé¦™æ¸¯åœ°å›¾
            echarts.registerMap('HK', geoJson);

            // ç¼“å­˜åŸå§‹æ•°æ®ï¼Œæ”¯æŒåœ¨å‰ç«¯åˆ‡æ¢ä¸åŒæŒ‡æ ‡
            const items = mapData.items || [];

                // æ ¹æ®é€‰æ‹©çš„æŒ‡æ ‡æ„å»º option
                function buildMapOption(metricKey, metricLabel) {
                let valueGetter;
                switch (metricKey) {
                    case 'cumulative':
                        valueGetter = d => d.cumulative ?? 0;
                        break;
                    case 'recovered':
                        valueGetter = d => d.recovered ?? 0;
                        break;
                    case 'deaths':
                        valueGetter = d => d.deaths ?? 0;
                        break;
                    // é»˜è®¤ä½¿ç”¨ç°å­˜ç¡®è¯Š
                    case 'active':
                    default:
                        valueGetter = d => d.active ?? 0;
                        break;
                }

                const seriesData = items.map(d => ({
                    ...d,
                    value: valueGetter(d),
                }));

                const maxValue = Math.max(...seriesData.map(i => i.value || 0)) || 100;

                return {
                    tooltip: {
                        trigger: 'item',
                        formatter: function (params) {
                            const d = params.data || {};
                            const displayName = d.district || d.name || params.name || '';
                            if (!displayName) {
                                return '';
                            }
                            return [
                                displayName,
                                'ç´¯è®¡ç¡®è¯Šï¼š' + (d.cumulative ?? 0).toLocaleString(),
                                'ç°å­˜ç¡®è¯Šï¼š' + (d.active ?? 0).toLocaleString(),
                                'ç´¯è®¡åº·å¤ï¼š' + (d.recovered ?? 0).toLocaleString(),
                                'ç´¯è®¡æ­»äº¡ï¼š' + (d.deaths ?? 0).toLocaleString()
                            ].join('<br/>');
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: maxValue,
                        left: 'left',
                        bottom: 20,
                        text: ['é«˜', 'ä½'],
                        calculable: true,
                        inRange: {
                            color: ['#e0f3ff', '#74b9ff', '#0984e3', '#d63031']
                        }
                    },
                    series: [{
                        name: metricLabel,
                        type: 'map',
                        map: 'HK',
                        roam: true,
                        label: {
                            show: true,
                            fontSize: 10
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontWeight: 'bold'
                            }
                        },
                        data: seriesData
                    }]
                };
            }

            // é»˜è®¤æ˜¾ç¤ºâ€œç´¯è®¡ç¡®è¯Šâ€ï¼ˆä¸å¤´éƒ¨æŒ‡æ ‡å¡è¯­ä¹‰å®Œå…¨ä¸€è‡´ï¼‰
            hkMapChart.setOption(buildMapOption('cumulative', 'ç´¯è®¡ç¡®è¯Š'));

            // ç»‘å®šä¸‹æ‹‰æ¡†ï¼Œæ”¯æŒå‰ç«¯åˆ‡æ¢ç€è‰²æŒ‡æ ‡
            const metricSelect = document.getElementById('mapMetricSelect');
            if (metricSelect) {
                metricSelect.addEventListener('change', function () {
                    const metricKey = this.value;
                    const labelMap = {
                        cumulative: 'ç´¯è®¡ç¡®è¯Š',
                        active: 'ç°å­˜ç¡®è¯Š',
                        recovered: 'ç´¯è®¡åº·å¤',
                        deaths: 'ç´¯è®¡æ­»äº¡'
                    };
                    hkMapChart.setOption(buildMapOption(metricKey, labelMap[metricKey] || 'ç°å­˜ç¡®è¯Š'));
                });
            }
        })
        .catch(error => console.error('åŠ è½½é¦™æ¸¯åœ°å›¾æ•°æ®å¤±è´¥:', error));

        // 4. åŠ è½½å„åŒºç´¯è®¡ç¡®è¯Šæ’è¡Œ
        fetch('/api/districts/ranking')
            .then(response => response.json())
            .then(data => {
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'value',
                        name: 'ç´¯è®¡ç¡®è¯Šäººæ•°'
                    },
                    yAxis: {
                        type: 'category',
                        data: data.districts,
                        inverse: true
                    },
                    series: [{
                        name: 'ç´¯è®¡ç¡®è¯Š',
                        type: 'bar',
                        data: data.cumulative_cases,
                        itemStyle: {
                            color: function(params) {
                                const colors = ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'];
                                return colors[params.dataIndex % colors.length];
                            }
                        },
                        label: {
                            show: true,
                            position: 'right',
                            formatter: '{c}'
                        }
                    }]
                };
                districtBarChart.setOption(option);
            })
            .catch(error => console.error('åŠ è½½æ’è¡Œæ•°æ®å¤±è´¥:', error));

        // 5. åŠ è½½é£é™©ç­‰çº§åˆ†å¸ƒ
        fetch('/api/risk/distribution')
            .then(response => response.json())
            .then(data => {
                const option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left'
                    },
                    series: [{
                        name: 'é£é™©ç­‰çº§',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            formatter: '{b}: {c}\n({d}%)'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '20',
                                fontWeight: 'bold'
                            }
                        },
                        data: data.data.map(item => ({
                            ...item,
                            itemStyle: {
                                color: item.name === 'é«˜é£é™©' ? '#e74c3c' : 
                                       item.name === 'ä¸­é£é™©' ? '#f39c12' : '#2ecc71'
                            }
                        }))
                    }]
                };
                riskChart.setOption(option);
            })
            .catch(error => console.error('åŠ è½½é£é™©åˆ†å¸ƒæ•°æ®å¤±è´¥:', error));

        // 6. åŠ è½½é‡ç‚¹åœ°åŒºè¶‹åŠ¿å¯¹æ¯”
        fetch('/api/districts/trend')
            .then(response => response.json())
            .then(data => {
                const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];
                const series = data.series.map((item, index) => ({
                    name: item.name,
                    type: 'line',
                    smooth: true,
                    data: item.data,
                    itemStyle: {
                        color: colors[index % colors.length]
                    },
                    lineStyle: {
                        width: 2
                    }
                }));

                const option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    legend: {
                        data: data.series.map(s => s.name),
                        top: 10
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: data.dates,
                        axisLabel: {
                            rotate: 45,
                            interval: Math.floor(data.dates.length / 10)
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'æ–°å¢ç¡®è¯Šäººæ•°'
                    },
                    series: series
                };
                top5TrendChart.setOption(option);
            })
            .catch(error => console.error('åŠ è½½é‡ç‚¹åœ°åŒºè¶‹åŠ¿æ•°æ®å¤±è´¥:', error));
    </script>
</body>
</html>
